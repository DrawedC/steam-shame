<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ player_name }}'s Steam Shame</title>
    <meta property="og:title" content="{{ player_name }}'s Steam Shame: {{ stats.shame_score }}%">
    <meta property="og:description" content="I own {{ stats.total_games }} games and have never touched {{ stats.never_played_count }} of them.">
    <meta property="og:image" content="{{ request.url_root }}share/{{ steam_id }}.png">
    <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="{{ request.url_root }}share/{{ steam_id }}.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üò¨</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
<style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',-apple-system,sans-serif;background:#0a0a0c;min-height:100vh;color:#e5e5e5;overflow-x:hidden;font-size:1.05rem;line-height:1.58}

    html{font-size:16px}
    @media (min-width:900px)  { html{font-size:16.5px} }
    @media (min-width:1024px) { html{font-size:17.5px} }
    @media (min-width:1280px) { html{font-size:18.5px} }
    @media (min-width:1440px) { html{font-size:19px} }

    /* Top bar */
    .top-bar{position:fixed;top:0;left:0;right:0;z-index:100;padding:0.8rem 1.5rem;display:flex;align-items:center;gap:1rem;background:rgba(10,10,12,.92);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.06);transition:transform .3s}
    .top-bar.hidden{transform:translateY(-100%)}
    .top-logo{color:#fff;font-weight:800;font-size:1.1rem;white-space:nowrap;text-decoration:none}.top-logo span{color:#ff3366}
    .top-search{flex:1;max-width:420px;display:flex}
    .top-search input{flex:1;padding:0.55rem 1rem;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px 0 0 10px;color:#fff;font-size:0.95rem;outline:none}.top-search input:focus{border-color:#00a8ff}.top-search input::placeholder{color:#666}
    .top-search button{padding:0.55rem 1.1rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);border-left:none;border-radius:0 10px 10px 0;color:#ddd;font-size:0.95rem;cursor:pointer}.top-search button:hover{background:#00a8ff22;color:#fff}

    /* Hero ‚Äì less forced height */
    .hero{padding:5rem 1.5rem 3.5rem;text-align:center;position:relative;background:radial-gradient(ellipse at 50% 0%,rgba(120,0,255,.08),transparent 60%),#0a0a0c}
    .player-header{display:flex;align-items:center;justify-content:center;gap:1.2rem;margin-bottom:1.8rem;opacity:0;animation:fadeUp .6s ease forwards}
    .avatar{width:64px;height:64px;border-radius:50%;border:2px solid rgba(255,255,255,.15)}
    .player-name{font-size:1.5rem;font-weight:700}.player-sub{color:#666;font-size:0.95rem;margin-top:0.2rem}
    .shame-display{opacity:0;animation:fadeUp .6s ease .2s forwards}
    .shame-num{font-size:clamp(7rem,22vw,13rem);font-weight:900;line-height:1;background:linear-gradient(135deg,#ff3366,#ff6b35 50%,#f7c94b);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .shame-num::after{content:'%';font-size:.32em;position:absolute;top:.55em}
    .shame-label{font-size:1.25rem;font-weight:600;color:#555;text-transform:uppercase;letter-spacing:.18em;margin-top:.6rem}

    .hero-stats{display:flex;justify-content:center;gap:2.5rem;margin:1.2rem 0;opacity:0;animation:fadeUp .7s ease .3s forwards}
    .hero-stat-val{font-size:1.4rem;font-weight:700}.hero-stat-val.red{color:#ff3366}
    .hero-stat-lbl{font-size:0.8rem;color:#666;margin-top:0.15rem;text-transform:uppercase;letter-spacing:.05em}

    .hero-badges{display:flex;flex-wrap:wrap;gap:0.7rem;justify-content:center;margin:1.4rem 0;opacity:0;animation:fadeUp .7s ease .45s forwards}
    .hero-badge{display:inline-flex;align-items:center;gap:0.6rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);border-radius:12px;padding:0.55rem 1.1rem;min-width:0}
    .hero-badge-icon{font-size:1.3rem;flex-shrink:0}.hero-badge-text{min-width:0}
    .hero-badge-name{font-size:0.95rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hero-badge-desc{font-size:0.8rem;color:#777;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hero-badge.highlight{border-color:#ff336644;background:#ff336611}.hero-badge.highlight .hero-badge-name{color:#ff3366}

    .scroll-hint{position:absolute;bottom:1.8rem;left:50%;transform:translateX(-50%);color:#333;font-size:0.9rem;opacity:0;animation:fadeUp .8s ease .7s forwards,bounce 2.2s ease-in-out infinite}
    .scroll-hint span{display:block;margin-top:0.3rem;font-size:1.2rem}

    /* Sections ‚Äì tighter vertical rhythm */
    .sec{padding:2.5rem 1.5rem}.sec+.sec{border-top:1px solid rgba(255,255,255,.04)}
    .sec-in{max-width:980px;margin:0 auto}
    .sec-title{font-size:clamp(1.6rem,4vw,2.1rem);font-weight:800;margin-bottom:0.5rem}
    .sec-sub{font-size:1.05rem;color:#666;margin-bottom:1.6rem}

    /* Pie */
    .pie-area{display:flex;align-items:center;justify-content:center;gap:2rem;flex-wrap:wrap;margin:1.5rem 0}
    .pie-box{width:300px;height:300px;flex-shrink:0}

    /* DNA toggles ‚Äì now properly clickable looking */
    .dna-toggles{display:flex;flex-wrap:wrap;gap:0.6rem;justify-content:center;margin:0.8rem 0 1.2rem}
    .dna-btn{
        padding:0.5rem 1.2rem;
        border-radius:9999px;
        font-size:0.92rem;
        font-weight:600;
        cursor:pointer;
        border:2px solid transparent;
        background:rgba(255,255,255,0.07);
        color:#bbb;
        transition:all 0.18s;
    }
    .dna-btn:hover{
        background:rgba(255,255,255,0.14);
        color:white;
        transform:translateY(-1px);
    }
    .dna-btn.active{
        color:white;
        box-shadow:0 0 0 3px rgba(255,255,255,0.1);
    }
    .dna-btn[data-layer="owned"].active   {background:rgba(0,168,255,0.25);border-color:#00a8ff;color:#00a8ff}
    .dna-btn[data-layer="played"].active  {background:rgba(0,210,106,0.25);border-color:#00d26a;color:#00d26a}
    .dna-btn[data-layer="unplayed"].active{background:rgba(255,51,102,0.25);border-color:#ff3366;color:#ff3366}

    .radar-box{display:flex;justify-content:center;margin:1rem 0}
    .radar-disclaimer{text-align:center;color:#444;font-size:0.8rem;font-style:italic;margin-top:0.4rem}

    /* Info rows */
    .info-row{display:flex;gap:1.2rem;align-items:center;margin:1.1rem 0;padding:1.1rem 1.3rem;background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.07);border-radius:14px}
    .info-main{font-size:1.15rem;font-weight:700}.info-main .val{font-size:1.35rem}
    .info-sub{font-size:0.9rem;color:#777}
    .info-icon{font-size:2.4rem;flex-shrink:0;order:1}

    /* Suggest / Leaderboard / Share ‚Äì keeping mostly original but tighter */
    .suggest{margin:1.5rem 0}
    .lb{margin:1.5rem 0}
    .share{padding:2.8rem 1.5rem;border-top:1px solid rgba(255,255,255,.04);text-align:center}
    .share-title{font-size:1.5rem;font-weight:700;margin-bottom:0.6rem}
    .share-sub{color:#666;margin-bottom:1.4rem}

    /* Modal, loading, animations unchanged ‚Äì omitted for brevity */

    /* Desktop tweaks */
    @media(min-width:1024px){
        .hero{padding:6rem 2rem 4rem}
        .shame-num{font-size:clamp(11rem,19vw,15rem)}
        .hero-stats{gap:3.5rem}
        .hero-stat-val{font-size:1.7rem}
        .pie-box{width:340px;height:340px}
        .sec{padding:3.2rem 2rem}
        .sec-in{max-width:1100px}
        .info-row{padding:1.3rem 1.6rem}
        .info-main{font-size:1.3rem}
        .info-main .val{font-size:1.55rem}
        .dna-toggles{gap:0.8rem}
        .dna-btn{font-size:1rem;padding:0.6rem 1.4rem}
    }

    @media(max-width:640px){
        .hero{padding:4.5rem 1rem 3rem}
        .shame-num{font-size:clamp(6rem,20vw,10rem)}
        .hero-stats{gap:1.8rem}
        .pie-box{width:260px;height:260px}
        .info-icon{font-size:2.1rem}
    }
</style>
</head>
<body>
<div class="top-bar" id="topbar">
    <a href="/" class="top-logo">Steam<span>Shame</span></a>
    <form action="/lookup" method="POST" class="top-search"><input type="text" name="steam_input" placeholder="Steam URL or username" autocomplete="off"><button type="submit">Check</button></form>
</div>

<section class="hero" style="padding-top:4.5rem">
    <div class="player-header"><img src="{{ avatar_url }}" alt="" class="avatar"><div><div class="player-name">{{ player_name }}</div><div class="player-sub">Steam Shame Report</div></div></div>
    <div class="shame-display"><div class="shame-num">{{ stats.shame_score }}</div><div class="shame-label">Shame Score</div></div>
    <div class="hero-stats">
        <div><div class="hero-stat-val">{{ stats.total_games }}</div><div class="hero-stat-lbl">Games Owned</div></div>
        <div><div class="hero-stat-val red">{{ stats.never_played_count }}</div><div class="hero-stat-lbl">Never Played</div></div>
    </div>
    <div class="hero-badges">
        <div class="hero-badge"><div class="hero-badge-icon">{{ stats.descriptor.emoji }}</div><div class="hero-badge-text"><div class="hero-badge-name">{{ stats.descriptor.title }}</div><div class="hero-badge-desc">{{ stats.descriptor.description }}</div></div></div>
        {% for b in instant_badges %}
        <div class="hero-badge"><div class="hero-badge-icon">{{ b.emoji }}</div><div class="hero-badge-text"><div class="hero-badge-name">{{ b.name }}</div><div class="hero-badge-desc">{{ b.description }}</div></div></div>
        {% endfor %}
        <div id="badges-slot"></div>
    </div>
    <div class="scroll-hint">Scroll for the damage<span>&#8595;</span></div>
</section>

<section class="sec"><div class="sec-in">
    <div class="sec-title">The Shame Pile</div>
    <div class="sec-sub">{{ stats.total_games }} games, broken down</div>
    <div class="pie-area">
        <div class="pie-box"><canvas id="pie-cv"></canvas></div>
    </div>
    <div id="pie-detail" class="detail-panel"></div>

    <div id="val-load" class="loading"><div class="spin"></div>Calculating library value...</div>
    <div id="val-out" style="display:none"></div>

    {% if stats.backlog_days > 0 %}
    <div class="info-row">
        <div class="info-text"><div class="info-main"><span class="val orange">{{ stats.backlog_days }} days</span> to clear your backlog</div><div class="info-sub">At 1 hour per day, ~10 hrs per game{% if stats.backlog_days > 365 %} ‚Äî that's {{ (stats.backlog_days/365)|round(1) }} years{% endif %}</div></div>
        <div class="info-icon">‚è≥</div>
    </div>
    {% endif %}
</div></section>

<section class="sec" id="dna-sec"><div class="sec-in">
    <div class="sec-title">Gamer DNA</div>
    <div class="sec-sub">What your library says about you</div>
    <div id="dna-load" class="loading"><div class="spin"></div>Analyzing your genres...</div>
    <div id="dna-out" style="display:none"></div>
</div></section>

<section class="sec"><div class="sec-in">
    <div id="suggest-out" style="display:none"></div>
</div></section>

<section class="sec" id="lb-sec"><div class="sec-in">
    <div class="sec-title">Friends Leaderboard</div>
    <div class="sec-sub">Who wastes the most?</div>
    <div id="lb-load" class="loading"><div class="spin"></div>Loading friends...</div>
    <div id="lb-out" style="display:none"></div>
</div></section>

<section class="share">
    <div class="share-title">Spread the shame</div>
    <div class="share-sub">Let your friends see how they compare</div>
    <div class="share-btns">
        <a href="https://twitter.com/intent/tweet?text=My%20Steam%20Shame%3A%20{{ stats.shame_score }}%25%20%E2%80%94%20{{ stats.total_games }}%20games%2C%20{{ stats.never_played_count }}%20never%20played&url={{ request.url }}" target="_blank" class="s-btn tw">Share on X</a>
        <button class="s-btn cp" onclick="copyLink()">Copy Link</button>
    </div>
</section>

<div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()"><div class="modal">
    <div class="modal-head"><div class="modal-t" id="modal-t"></div><button class="modal-x" onclick="closeModal()">&#x2715;</button></div>
    <div class="modal-body" id="modal-b"></div>
</div></div>

<script>
Chart.register(ChartDataLabels);
const SID="{{steam_id}}";
const S=[
    {l:'Played',c:'#00d26a',n:{{stats.played_count}},t:{{stats.played_total}},pct:'{{(stats.played_count/stats.total_games*100)|round(1)}}%',
     g:[{% for g in stats.played_games %}{"name":"{{g.name|replace('\\','\\\\')|replace('"','\\"')}}","pt":"{{g.playtime_fmt}}"}{% if not loop.last %},{% endif %}{% endfor %}]},
    {l:'Abandoned',c:'#ff6b35',n:{{stats.abandoned_count}},t:{{stats.abandoned_total}},pct:'{{(stats.abandoned_count/stats.total_games*100)|round(1)}}%',
     g:[{% for g in stats.abandoned_games %}{"name":"{{g.name|replace('\\','\\\\')|replace('"','\\"')}}","pt":"{{g.playtime_fmt}}"}{% if not loop.last %},{% endif %}{% endfor %}]},
    {l:'Never Played',c:'#ff3366',n:{{stats.never_played_count}},t:{{stats.unplayed_total}},pct:'{{(stats.never_played_count/stats.total_games*100)|round(1)}}%',
     g:[{% for g in stats.unplayed_games %}{"name":"{{g.name|replace('\\','\\\\')|replace('"','\\"')}}","pt":"‚Äî"}{% if not loop.last %},{% endif %}{% endfor %}]}
];
const MOST_PLAYED = {% if stats.most_played %}{"name":"{{stats.most_played.name|replace('\\','\\\\')|replace('"','\\"')}}","pt":"{{stats.most_played.playtime_fmt}}"}{% else %}null{% endif %};
// Full lists for "Show all" modal
const FULL=[
    [{% for g in stats.all_played %}{"name":"{{g.name|replace('\\','\\\\')|replace('"','\\"')}}","pt":"{{g.playtime_fmt}}"}{% if not loop.last %},{% endif %}{% endfor %}],
    [{% for g in stats.all_abandoned %}{"name":"{{g.name|replace('\\','\\\\')|replace('"','\\"')}}","pt":"{{g.playtime_fmt}}"}{% if not loop.last %},{% endif %}{% endfor %}],
    [{% for g in stats.all_unplayed %}{"name":"{{g.name|replace('\\','\\\\')|replace('"','\\"')}}","pt":"‚Äî"}{% if not loop.last %},{% endif %}{% endfor %}]
];
let PD=null,RC=null,RL='owned';

function show(id,h){document.getElementById(id+'-load').style.display='none';const e=document.getElementById(id+'-out');e.innerHTML=h;e.style.display='block'}
function openModal(t,g){
    document.getElementById('modal-t').innerHTML=t+(g.length?' <span class="modal-cnt">('+g.length+')</span>':'');
    let h='';g.forEach(x=>{h+='<div class="modal-item">'+(typeof x==='string'?x:x.name+(x.pt&&x.pt!=='‚Äî'?' <span style="color:#444;font-size:.7rem">'+x.pt+'</span>':''))+'</div>'});
    if(!g.length)h='<div class="modal-item" style="color:#333">Nothing here</div>';
    document.getElementById('modal-b').innerHTML=h;document.getElementById('modal').classList.add('on');document.body.style.overflow='hidden'}
function closeModal(){document.getElementById('modal').classList.remove('on');document.body.style.overflow=''}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});
let lastY=0;window.addEventListener('scroll',()=>{const y=window.scrollY;document.getElementById('topbar').classList.toggle('hidden',y>100&&y>lastY);lastY=y},{passive:true});

// Pie
new Chart(document.getElementById('pie-cv'),{type:'doughnut',
    data:{labels:S.map(s=>s.l),datasets:[{data:S.map(s=>s.n),backgroundColor:S.map(s=>s.c),borderColor:'#0a0a0c',borderWidth:2,hoverOffset:12}]},
    options:{responsive:true,maintainAspectRatio:true,cutout:'42%',
        plugins:{legend:{display:true,position:'bottom',labels:{color:'#888',font:{size:12,family:'Inter'},padding:16,usePointStyle:true,pointStyleWidth:10}},
        datalabels:{color:'#fff',font:{weight:'700',size:13,family:'Inter'},
            formatter:(v,ctx)=>{const t=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);const p=((v/t)*100).toFixed(1);return v>0?p+'%':''},
            anchor:'center',align:'center',textShadowBlur:4,textShadowColor:'rgba(0,0,0,.6)'}},
        onClick:(e,el)=>{if(el.length)selectPie(el[0].index)}}});

function selectPie(i){
    const s=S[i],p=document.getElementById('pie-detail');
    let h='<div class="detail-header"><div class="detail-title" style="color:'+s.c+'">'+s.l+' ‚Äî '+s.n+' games ('+s.pct+')</div><button class="detail-close" onclick="closePie()">&#x2715;</button></div><div class="detail-list">';
    s.g.forEach(g=>{h+='<div class="g-row"><div class="g-name">'+g.name+'</div><div class="g-time">'+g.pt+'</div></div>'});
    if(!s.g.length)h+='<div class="g-row"><div class="g-name" style="color:#333">No games to show</div></div>';
    h+='</div>';if(s.t>s.g.length)h+='<button class="expand-btn" onclick="openModal(\''+s.l.replace(/'/g,"\\'")+'\',FULL['+i+'])">Show all '+s.t+'</button>';
    p.innerHTML=h;p.classList.add('open');p.scrollIntoView({behavior:'smooth',block:'nearest'})}
function closePie(){document.getElementById('pie-detail').classList.remove('open')}

// Value ‚Äî emoji on far right
function loadVal(full){
    const ld=document.getElementById('val-load'),out=document.getElementById('val-out');
    ld.style.display='block';out.style.display='none';
    if(full)ld.innerHTML='<div class="spin"></div>Scanning full library...';
    fetch('/api/value/'+SID+(full?'?full=1':'')).then(r=>r.json()).then(d=>{
        if(d.error){ld.style.display='none';return}
        const e=d.is_estimate?'~':'';
        let h='<div class="info-row"><div class="info-text"><div class="info-main">{{stats.total_games}} titles, estimated value <span class="val green">'+e+'$'+d.library_value.toLocaleString()+'</span></div><div class="info-sub">Your complete Steam library at current store prices</div></div><div class="info-icon">üìö</div></div>';
        h+='<div class="info-row"><div class="info-text"><div class="info-main">{{stats.never_played_count}} titles collecting dust, worth <span class="val red">'+e+'$'+d.unplayed_value.toLocaleString()+'</span></div><div class="info-sub">Games purchased that remain completely unplayed</div></div><div class="info-icon">üï∏Ô∏è</div></div>';
        h+='<div style="text-align:center;margin-bottom:1rem"><div style="color:#333;font-size:.7rem;font-style:italic;margin-bottom:.5rem">*Based on current MSRP. Does not reflect sale prices.</div>';
        if(d.is_estimate)h+='<button class="expand-btn" style="display:inline-block;width:auto;padding:.4rem 1.2rem;border:1px solid rgba(255,255,255,.06);border-radius:8px" onclick="loadVal(true)">Scan full library for accuracy</button>';
        h+='</div>';
        ld.style.display='none';out.innerHTML=h;out.style.display='block';
    }).catch(()=>{ld.style.display='none'})}

// Suggest ‚Äî less ad-like, no most played time
function loadSuggest(){
    fetch('/api/suggest/'+SID).then(r=>r.json()).then(d=>{
        if(d.error||!d.appid)return;
        const el=document.getElementById('suggest-out');
        el.innerHTML='<div class="suggest"><img src="'+d.image+'" class="suggest-img" alt="" onerror="this.style.display=\'none\'"><div class="suggest-body"><div class="suggest-eye">Maybe play this next?</div><div class="suggest-name">'+d.name+'</div><div class="suggest-actions"><a href="'+d.store_url+'" target="_blank" class="btn-steam">View on Steam</a><button class="btn-reroll" onclick="loadSuggest()">Pick another</button></div></div></div>';
        el.style.display='block';
    }).catch(()=>{})}

// Staggered loading
loadVal(false);loadSuggest();
setTimeout(()=>{
fetch('/api/personality/'+SID).then(r=>r.json()).then(data=>{
    if(data.error){show('dna','<p style="text-align:center;color:#444">'+data.error+'</p>');return}
    PD=data;const r=data.radar;
    if(!r||!r.labels||!r.labels.length){show('dna','<p style="text-align:center;color:#444">Not enough genre data.</p>');return}

    // FILTER: only show genres that have data (any non-zero value across owned/played/unplayed)
    const validIdx=[];
    for(let i=0;i<r.labels.length;i++){
        if(r.owned[i]>0||r.played[i]>0||r.unplayed[i]>0)validIdx.push(i);
    }
    const fLabels=validIdx.map(i=>r.labels[i]);
    const fOwned=validIdx.map(i=>r.owned[i]);
    const fPlayed=validIdx.map(i=>r.played[i]);
    const fUnplayed=validIdx.map(i=>r.unplayed[i]);

    if(!fLabels.length){show('dna','<p style="text-align:center;color:#444">Not enough genre data.</p>');return}

    let h='';
    if(data.show_unplayed_mismatch&&data.unplayed_majority&&data.played_majority){
        h+='<div class="mismatch"><div class="mismatch-title">You buy '+data.unplayed_majority.emoji+' '+data.unplayed_majority.label+' but play '+data.played_majority.emoji+' '+data.played_majority.label+'</div><div class="mismatch-sub">Your unplayed library tells a different story than your playtime</div></div>'}

    // Tighter radar sizing
    const radarSize=Math.min(460,window.innerWidth-60);
    h+='<div class="radar-box"><canvas id="radar-cv" width="'+radarSize+'" height="'+radarSize+'" style="max-width:'+radarSize+'px;width:100%"></canvas></div>';
    h+='<div class="dna-toggles">';
    if(data.overall_majority)h+='<div class="dna-btn active" data-layer="owned">Library: '+data.overall_majority.emoji+' '+data.overall_majority.label+' '+data.overall_majority.pct+'%</div>';
    if(data.played_majority)h+='<div class="dna-btn" data-layer="played">Played: '+data.played_majority.emoji+' '+data.played_majority.label+' '+data.played_majority.pct+'%</div>';
    if(data.unplayed_majority)h+='<div class="dna-btn" data-layer="unplayed">Unplayed: '+data.unplayed_majority.emoji+' '+data.unplayed_majority.label+' '+data.unplayed_majority.pct+'%</div>';
    h+='</div>';
    h+='<div class="radar-disclaimer">Based on a sample of your library</div>';

    // Async badges: only mismatch + early access (instant badges already rendered server-side)
    let bh='';
    if(data.mismatch_badge)bh+='<div class="hero-badge highlight"><div class="hero-badge-icon">'+data.mismatch_badge.emoji+'</div><div class="hero-badge-text"><div class="hero-badge-name">'+data.mismatch_badge.title+'</div><div class="hero-badge-desc">'+data.mismatch_badge.description+'</div></div></div>';
    if(data.badges){
        // Only add badges not already rendered (Early Access Addict is the async one)
        const instantNames=new Set([{% for b in instant_badges %}"{{b.name}}",{% endfor %}]);
        data.badges.forEach(b=>{if(!instantNames.has(b.name))bh+='<div class="hero-badge"><div class="hero-badge-icon">'+b.emoji+'</div><div class="hero-badge-text"><div class="hero-badge-name">'+b.name+'</div><div class="hero-badge-desc">'+b.description+'</div></div></div>'});
    }
    document.getElementById('badges-slot').innerHTML=bh;
    show('dna',h);

    const lb=fLabels.map(l=>l.emoji+' '+l.label);
    const A={owned:{bg:'rgba(0,168,255,0.2)',br:'#00a8ff'},played:{bg:'rgba(0,210,106,0.2)',br:'#00d26a'},unplayed:{bg:'rgba(255,51,102,0.2)',br:'#ff3366'}};
    RC=new Chart(document.getElementById('radar-cv'),{type:'radar',
        data:{labels:lb,datasets:[
            {label:'Library',data:fOwned,backgroundColor:A.owned.bg,borderColor:A.owned.br,borderWidth:2,pointRadius:3,pointBackgroundColor:A.owned.br},
            {label:'Played',data:fPlayed,backgroundColor:'rgba(0,210,106,0.05)',borderColor:'rgba(0,210,106,0.2)',borderWidth:1,pointRadius:1.5,pointBackgroundColor:'rgba(0,210,106,0.2)'},
            {label:'Unplayed',data:fUnplayed,backgroundColor:'rgba(255,51,102,0.05)',borderColor:'rgba(255,51,102,0.2)',borderWidth:1,pointRadius:1.5,pointBackgroundColor:'rgba(255,51,102,0.2)'}]},
        options:{responsive:true,maintainAspectRatio:true,
            scales:{r:{grid:{color:'rgba(255,255,255,0.05)'},angleLines:{color:'rgba(255,255,255,0.05)'},pointLabels:{color:'#999',font:{size:11,weight:'500',family:'Inter'},padding:8},ticks:{display:false},suggestedMin:0}},
            plugins:{legend:{display:false},datalabels:{display:false},
                tooltip:{backgroundColor:'#1a1a1e',titleColor:'#fff',bodyColor:'#bbb',borderColor:'rgba(255,255,255,.06)',borderWidth:1,padding:8,displayColors:true,callbacks:{label:c=>c.dataset.label+': '+c.raw+'%'}}}}});
}).catch(()=>show('dna','<p style="color:#444;text-align:center">Failed to load.</p>'));
},200);

setTimeout(()=>{
fetch('/api/friends/'+SID).then(r=>r.json()).then(data=>{
    if(data.error&&!data.leaderboard){show('lb','<p style="text-align:center;color:#444">'+data.error+'</p>');return}
    if(!data.leaderboard||data.leaderboard.length<=1){show('lb','<p style="text-align:center;color:#444">No friends with public profiles found.</p>');return}
    let h='';
    if(data.user_rank===1)h+='<div class="callout"><div class="callout-emoji">&#x1F451;</div><div class="callout-text">#1 most wasteful among your friends</div></div>';
    else if(data.user_rank<=3)h+='<div class="callout"><div class="callout-emoji">&#x1F62C;</div><div class="callout-text">#'+data.user_rank+' most wasteful among friends</div></div>';
    else if(data.user_rank===data.leaderboard.length)h+='<div class="callout win"><div class="callout-emoji">&#x1F3C6;</div><div class="callout-text">Least wasteful among your friends</div></div>';
    h+='<div class="lb"><div class="lb-head"><div></div><div>Name</div><div>Shame</div><div>Games</div><div>Unplayed</div></div>';
    data.leaderboard.forEach(e=>{
        const ri=e.rank===1?'&#x1F451;':e.rank===2?'&#x1F948;':e.rank===3?'&#x1F949;':e.rank;
        h+='<div class="lb-row '+(e.is_user?'me':'')+'"><div class="lb-rank '+(e.rank<=3?'r'+e.rank:'')+'">'+ri+'</div><div class="lb-player"><img src="'+e.avatar+'" class="lb-av"><span class="lb-nm"><a href="/results/'+e.steam_id+'">'+e.name+'</a>'+(e.is_user?'<span class="lb-you">(you)</span>':'')+'</span></div><div class="lb-score '+(e.shame_score<25?'lo':e.shame_score<40?'md':'hi')+'">'+e.shame_score+'%</div><div class="lb-meta">'+e.total_games+'</div><div class="lb-meta">'+e.never_played+'</div></div>'});
    h+='</div>';show('lb',h);
}).catch(()=>show('lb','<p style="text-align:center;color:#444">Could not load friends.</p>'));
},500);

function copyLink(){navigator.clipboard.writeText(window.location.href).then(()=>{const b=document.querySelector('.s-btn.cp');b.textContent='Copied!';setTimeout(()=>b.textContent='Copy Link',2000)})}
</script>
</body></html>
